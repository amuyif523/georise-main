generator client {
  provider = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  extensions = [postgis(map: "postgis")]
}

enum Role {
  CITIZEN
  AGENCY_STAFF
  ADMIN
}

enum VerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum IncidentStatus {
  RECEIVED
  UNDER_REVIEW
  ASSIGNED
  RESPONDING
  RESOLVED
  CANCELLED
}

enum ReviewStatus {
  NOT_REQUIRED
  PENDING_REVIEW
  APPROVED
  REJECTED
}

enum ResponderStatus {
  AVAILABLE
  ASSIGNED
  EN_ROUTE
  ON_SCENE
  OFFLINE
}

enum ActivityType {
  STATUS_CHANGE
  COMMENT
  DISPATCH
  ASSIGNMENT
  SYSTEM
}

enum AgencyType {
  POLICE
  FIRE
  MEDICAL
  TRAFFIC
  DISASTER
  ELECTRIC
  WATER
  ENVIRONMENT
  PUBLIC_HEALTH
  CONSTRUCTION
  ADMINISTRATION
  OTHER
}

model User {
  id           Int       @id @default(autoincrement())
  fullName     String
  email        String    @unique
  phone        String?   @unique
  passwordHash String
  role         Role      @default(CITIZEN)
  isActive     Boolean   @default(true)
  isShadowBanned Boolean @default(false)
  tokenVersion Int       @default(0)
  failedLoginAttempts Int @default(0)
  lockedUntil  DateTime?
  trustScore   Int       @default(0)
  totalReports Int       @default(0)
  validReports Int       @default(0)
  rejectedReports Int    @default(0)
  lastReportAt DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  citizenVerification CitizenVerification?
  agencyStaff         AgencyStaff?
  incidentsReported   Incident[]             @relation("IncidentsReportedByUser")
  statusHistory       IncidentStatusHistory[]
  auditLogs           AuditLog[]
  reviewedIncidents   Incident[]             @relation("IncidentReviewUser")
  activityLogs        ActivityLog[]
  responders          Responder[]
}

model Agency {
  id          Int         @id @default(autoincrement())
  name        String
  type        AgencyType
  city        String
  description String?
  isApproved  Boolean     @default(false)
  isActive    Boolean     @default(false)
  boundary    Unsupported("geometry(Polygon,4326)")?
  centerLatitude  Float?
  centerLongitude Float?
  jurisdiction    Unsupported("geometry(Polygon,4326)")?
  subCityId   Int?
  woredaId    Int?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  subCity   SubCity? @relation(fields: [subCityId], references: [id])
  woreda    Woreda?  @relation(fields: [woredaId], references: [id])
  staff     AgencyStaff[]
  incidents Incident[]   @relation("IncidentsAssignedToAgency")
  jurisdictions AgencyJurisdiction[]
  responders  Responder[]

  @@index([boundary], name: "agency_boundary_idx", type: Gist)
  @@index([jurisdiction], name: "agency_jurisdiction_idx", type: Gist)
}

model AuditLog {
  id         Int      @id @default(autoincrement())
  actorId    Int
  action     String
  targetType String
  targetId   Int?
  note       String?
  createdAt  DateTime @default(now())

  actor      User     @relation(fields: [actorId], references: [id])
}

model AgencyStaff {
  id       Int     @id @default(autoincrement())
  userId   Int     @unique
  agencyId Int
  position String?

  user   User   @relation(fields: [userId], references: [id])
  agency Agency @relation(fields: [agencyId], references: [id])
}

model CitizenVerification {
  id           Int                @id @default(autoincrement())
  userId       Int                @unique
  nationalId   String
  phone        String
  status       VerificationStatus @default(PENDING)
  otpCode      String?
  otpExpiresAt DateTime?
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  user User @relation(fields: [userId], references: [id])
}

model Incident {
  id               Int            @id @default(autoincrement())
  reporterId       Int
  assignedAgencyId Int?
  assignedResponderId Int?
  title            String
  description      String
  category         String?
  severityScore    Int?
  status           IncidentStatus @default(RECEIVED)
  latitude         Float?
  longitude        Float?
  location         Unsupported("geometry")?
  subCityId        Int?
  woredaId         Int?
  reviewStatus     ReviewStatus   @default(NOT_REQUIRED)
  reviewedById     Int?
  reviewedAt       DateTime?
  reviewNote       String?
  reportedAt       DateTime       @default(now())
  verifiedAt       DateTime?
  dispatchedAt     DateTime?
  arrivalAt        DateTime?
  resolvedAt       DateTime?
  isDemo           Boolean        @default(false)
  demoScenarioCode String?
  isReporterAtScene Boolean       @default(true)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  reporter       User                 @relation("IncidentsReportedByUser", fields: [reporterId], references: [id])
  assignedAgency Agency?              @relation("IncidentsAssignedToAgency", fields: [assignedAgencyId], references: [id])
  assignedResponder Responder?        @relation("IncidentAssignedResponder", fields: [assignedResponderId], references: [id])
  subCity        SubCity?             @relation(fields: [subCityId], references: [id])
  woreda         Woreda?              @relation(fields: [woredaId], references: [id])
  reviewer       User?                @relation("IncidentReviewUser", fields: [reviewedById], references: [id])
  aiOutput       IncidentAIOutput?
  statusHistory  IncidentStatusHistory[]
  activityLogs   ActivityLog[]
  responders     Responder[]          @relation("IncidentResponders")
  language       String?              @default("ENGLISH") // AMHARIC, ENGLISH, etc.

  @@index([location], name: "incident_location_idx", type: Gist)
}

model IncidentAIOutput {
  id                Int     @id @default(autoincrement())
  incidentId        Int     @unique
  modelVersion      String
  predictedCategory String
  severityScore     Int
  confidence        Float
  summary           String?

  incident Incident @relation(fields: [incidentId], references: [id])
}

model IncidentStatusHistory {
  id          Int            @id @default(autoincrement())
  incidentId  Int
  actorUserId Int
  fromStatus  IncidentStatus?
  toStatus    IncidentStatus
  note        String?
  changedAt   DateTime       @default(now())

  incident Incident @relation(fields: [incidentId], references: [id])
  actor     User     @relation(fields: [actorUserId], references: [id])
}

model ActivityLog {
  id         String       @id @default(cuid())
  incidentId Int
  userId     Int?
  type       ActivityType
  message    String
  createdAt  DateTime     @default(now())

  incident Incident @relation(fields: [incidentId], references: [id])
  user     User?    @relation(fields: [userId], references: [id])
}

model SubCity {
  id          Int       @id @default(autoincrement())
  name        String    @unique
  code        String?   @unique
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  jurisdiction Unsupported("geometry(Polygon,4326)")?

  agencies  Agency[]
  woredas   Woreda[]
  incidents Incident[]

  @@index([jurisdiction], name: "subcity_jurisdiction_idx", type: Gist)
}

model Woreda {
  id        Int      @id @default(autoincrement())
  name      String
  code      String?
  subCityId Int
  boundary  Unsupported("geometry(Polygon,4326)")?

  subCity   SubCity  @relation(fields: [subCityId], references: [id])
  incidents Incident[]
  agencies  Agency[]
  @@index([boundary], name: "woreda_boundary_idx", type: Gist)

  @@unique([subCityId, name])
}

model DispatchRule {
  id                Int        @id @default(autoincrement())
  category          String
  defaultAgencyType AgencyType
}

model AgencyJurisdiction {
  id           Int      @id @default(autoincrement())
  agencyId     Int
  boundaryType String   // SUBCITY or WOREDA
  boundaryId   Int      // gid from addis_subcities/addis_woredas
  createdAt    DateTime @default(now())

  agency Agency @relation(fields: [agencyId], references: [id])
}

model Responder {
  id           Int      @id @default(autoincrement())
  name         String
  type         String
  status       ResponderStatus @default(AVAILABLE)
  agencyId     Int
  incidentId   Int?
  userId       Int?
  latitude     Float?
  longitude    Float?
  lastSeenAt   DateTime?
  isDemo       Boolean  @default(false)
  demoScenarioCode String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  agency       Agency   @relation(fields: [agencyId], references: [id])
  incident     Incident? @relation("IncidentResponders", fields: [incidentId], references: [id])
  assignedIncidents Incident[] @relation("IncidentAssignedResponder")
  user         User?    @relation(fields: [userId], references: [id])
}

