
> backend@1.0.0 test
> dotenv -e .env.test -- vitest run


[1m[7m[36m RUN [39m[27m[22m [36mv2.1.9 [39m[90mC:/Users/Amanuel/Desktop/georise-main/backend[39m

[90mstdout[2m | test/gis.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env.test -- tip: ≡ƒöæ add access controls to secrets: https://dotenvx.com/ops

{"level":30,"time":1770638822416,"pid":1568,"hostname":"DESKTOP-3P240QT","msg":"Incident AI Queue initialized"}
{"level":50,"time":1770638822448,"pid":1568,"hostname":"DESKTOP-3P240QT","err":{"type":"AggregateError","message":"","stack":"AggregateError: \n    at internalConnectMultiple (node:net:1134:18)\n    at afterConnectMultiple (node:net:1715:7)","aggregateErrors":[{"type":"Error","message":"connect ECONNREFUSED ::1:6379","stack":"Error: connect ECONNREFUSED ::1:6379\n    at createConnectionError (node:net:1678:14)\n    at afterConnectMultiple (node:net:1708:16)","errno":-4078,"code":"ECONNREFUSED","syscall":"connect","address":"::1","port":6379},{"type":"Error","message":"connect ECONNREFUSED 127.0.0.1:6379","stack":"Error: connect ECONNREFUSED 127.0.0.1:6379\n    at createConnectionError (node:net:1678:14)\n    at afterConnectMultiple (node:net:1708:16)","errno":-4078,"code":"ECONNREFUSED","syscall":"connect","address":"127.0.0.1","port":6379}],"code":"ECONNREFUSED"},"msg":"Incident Queue error"}
 [31mΓ¥»[39m test/gis.test.ts [2m([22m[2m0 test[22m[2m)[22m
[90mstdout[2m | test/audit.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env.test -- tip: ≡ƒöä add secrets lifecycle management: https://dotenvx.com/ops

 [31mΓ¥»[39m test/audit.test.ts [2m([22m[2m4 tests[22m[2m | [22m[33m4 skipped[39m[2m)[22m[33m 1293[2mms[22m[39m
[90mstdout[2m | test/adminCrud.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env.test -- tip: ≡ƒôí add observability to secrets: https://dotenvx.com/ops

{"level":30,"time":1770638828183,"pid":13252,"hostname":"DESKTOP-3P240QT","msg":"Incident AI Queue initialized"}
{"level":50,"time":1770638828336,"pid":13252,"hostname":"DESKTOP-3P240QT","err":{"type":"AggregateError","message":"","stack":"AggregateError: \n    at internalConnectMultiple (node:net:1134:18)\n    at afterConnectMultiple (node:net:1715:7)","aggregateErrors":[{"type":"Error","message":"connect ECONNREFUSED ::1:6379","stack":"Error: connect ECONNREFUSED ::1:6379\n    at createConnectionError (node:net:1678:14)\n    at afterConnectMultiple (node:net:1708:16)","errno":-4078,"code":"ECONNREFUSED","syscall":"connect","address":"::1","port":6379},{"type":"Error","message":"connect ECONNREFUSED 127.0.0.1:6379","stack":"Error: connect ECONNREFUSED 127.0.0.1:6379\n    at createConnectionError (node:net:1678:14)\n    at afterConnectMultiple (node:net:1708:16)","errno":-4078,"code":"ECONNREFUSED","syscall":"connect","address":"127.0.0.1","port":6379}],"code":"ECONNREFUSED"},"msg":"Incident Queue error"}
 [31mΓ¥»[39m test/adminCrud.test.ts [2m([22m[2m0 test[22m[2m)[22m
[90mstdout[2m | test/userRbac.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env.test -- tip: ΓÜÖ∩╕Å  write to custom object with { processEnv: myObject }

{"level":30,"time":1770638831581,"pid":12876,"hostname":"DESKTOP-3P240QT","msg":"Incident AI Queue initialized"}
{"level":50,"time":1770638831753,"pid":12876,"hostname":"DESKTOP-3P240QT","err":{"type":"AggregateError","message":"","stack":"AggregateError: \n    at internalConnectMultiple (node:net:1134:18)\n    at afterConnectMultiple (node:net:1715:7)","aggregateErrors":[{"type":"Error","message":"connect ECONNREFUSED ::1:6379","stack":"Error: connect ECONNREFUSED ::1:6379\n    at createConnectionError (node:net:1678:14)\n    at afterConnectMultiple (node:net:1708:16)","errno":-4078,"code":"ECONNREFUSED","syscall":"connect","address":"::1","port":6379},{"type":"Error","message":"connect ECONNREFUSED 127.0.0.1:6379","stack":"Error: connect ECONNREFUSED 127.0.0.1:6379\n    at createConnectionError (node:net:1678:14)\n    at afterConnectMultiple (node:net:1708:16)","errno":-4078,"code":"ECONNREFUSED","syscall":"connect","address":"127.0.0.1","port":6379}],"code":"ECONNREFUSED"},"msg":"Incident Queue error"}
 [31mΓ¥»[39m test/userRbac.test.ts [2m([22m[2m0 test[22m[2m)[22m
[90mstdout[2m | test/incident.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env.test -- tip: ΓÜÖ∩╕Å  write to custom object with { processEnv: myObject }

{"level":30,"time":1770638834872,"pid":20860,"hostname":"DESKTOP-3P240QT","msg":"Incident AI Queue initialized"}
{"level":50,"time":1770638834899,"pid":20860,"hostname":"DESKTOP-3P240QT","err":{"type":"AggregateError","message":"","stack":"AggregateError: \n    at internalConnectMultiple (node:net:1134:18)\n    at afterConnectMultiple (node:net:1715:7)","aggregateErrors":[{"type":"Error","message":"connect ECONNREFUSED ::1:6379","stack":"Error: connect ECONNREFUSED ::1:6379\n    at createConnectionError (node:net:1678:14)\n    at afterConnectMultiple (node:net:1708:16)","errno":-4078,"code":"ECONNREFUSED","syscall":"connect","address":"::1","port":6379},{"type":"Error","message":"connect ECONNREFUSED 127.0.0.1:6379","stack":"Error: connect ECONNREFUSED 127.0.0.1:6379\n    at createConnectionError (node:net:1678:14)\n    at afterConnectMultiple (node:net:1708:16)","errno":-4078,"code":"ECONNREFUSED","syscall":"connect","address":"127.0.0.1","port":6379}],"code":"ECONNREFUSED"},"msg":"Incident Queue error"}
 [31mΓ¥»[39m test/incident.test.ts [2m([22m[2m0 test[22m[2m)[22m
[90mstdout[2m | test/auth.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env.test -- tip: ΓÜÖ∩╕Å  suppress all logs with { quiet: true }

{"level":30,"time":1770638838345,"pid":26664,"hostname":"DESKTOP-3P240QT","msg":"Incident AI Queue initialized"}
{"level":50,"time":1770638838519,"pid":26664,"hostname":"DESKTOP-3P240QT","err":{"type":"AggregateError","message":"","stack":"AggregateError: \n    at internalConnectMultiple (node:net:1134:18)\n    at afterConnectMultiple (node:net:1715:7)","aggregateErrors":[{"type":"Error","message":"connect ECONNREFUSED ::1:6379","stack":"Error: connect ECONNREFUSED ::1:6379\n    at createConnectionError (node:net:1678:14)\n    at afterConnectMultiple (node:net:1708:16)","errno":-4078,"code":"ECONNREFUSED","syscall":"connect","address":"::1","port":6379},{"type":"Error","message":"connect ECONNREFUSED 127.0.0.1:6379","stack":"Error: connect ECONNREFUSED 127.0.0.1:6379\n    at createConnectionError (node:net:1678:14)\n    at afterConnectMultiple (node:net:1708:16)","errno":-4078,"code":"ECONNREFUSED","syscall":"connect","address":"127.0.0.1","port":6379}],"code":"ECONNREFUSED"},"msg":"Incident Queue error"}
 [31mΓ¥»[39m test/auth.test.ts [2m([22m[2m0 test[22m[2m)[22m
[90mstdout[2m | test/passwordReset.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env.test -- tip: ≡ƒùé∩╕Å backup and recover secrets: https://dotenvx.com/ops

{"level":30,"time":1770638841582,"pid":7756,"hostname":"DESKTOP-3P240QT","msg":"Incident AI Queue initialized"}
{"level":50,"time":1770638841609,"pid":7756,"hostname":"DESKTOP-3P240QT","err":{"type":"AggregateError","message":"","stack":"AggregateError: \n    at internalConnectMultiple (node:net:1134:18)\n    at afterConnectMultiple (node:net:1715:7)","aggregateErrors":[{"type":"Error","message":"connect ECONNREFUSED ::1:6379","stack":"Error: connect ECONNREFUSED ::1:6379\n    at createConnectionError (node:net:1678:14)\n    at afterConnectMultiple (node:net:1708:16)","errno":-4078,"code":"ECONNREFUSED","syscall":"connect","address":"::1","port":6379},{"type":"Error","message":"connect ECONNREFUSED 127.0.0.1:6379","stack":"Error: connect ECONNREFUSED 127.0.0.1:6379\n    at createConnectionError (node:net:1678:14)\n    at afterConnectMultiple (node:net:1708:16)","errno":-4078,"code":"ECONNREFUSED","syscall":"connect","address":"127.0.0.1","port":6379}],"code":"ECONNREFUSED"},"msg":"Incident Queue error"}
 [31mΓ¥»[39m test/passwordReset.test.ts [2m([22m[2m0 test[22m[2m)[22m
[90mstdout[2m | test/adminMetrics.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env.test -- tip: ≡ƒöÉ encrypt with Dotenvx: https://dotenvx.com

{"level":30,"time":1770638844830,"pid":16584,"hostname":"DESKTOP-3P240QT","msg":"Incident AI Queue initialized"}
{"level":50,"time":1770638844856,"pid":16584,"hostname":"DESKTOP-3P240QT","err":{"type":"AggregateError","message":"","stack":"AggregateError: \n    at internalConnectMultiple (node:net:1134:18)\n    at afterConnectMultiple (node:net:1715:7)","aggregateErrors":[{"type":"Error","message":"connect ECONNREFUSED ::1:6379","stack":"Error: connect ECONNREFUSED ::1:6379\n    at createConnectionError (node:net:1678:14)\n    at afterConnectMultiple (node:net:1708:16)","errno":-4078,"code":"ECONNREFUSED","syscall":"connect","address":"::1","port":6379},{"type":"Error","message":"connect ECONNREFUSED 127.0.0.1:6379","stack":"Error: connect ECONNREFUSED 127.0.0.1:6379\n    at createConnectionError (node:net:1678:14)\n    at afterConnectMultiple (node:net:1708:16)","errno":-4078,"code":"ECONNREFUSED","syscall":"connect","address":"127.0.0.1","port":6379}],"code":"ECONNREFUSED"},"msg":"Incident Queue error"}
 [31mΓ¥»[39m test/adminMetrics.test.ts [2m([22m[2m0 test[22m[2m)[22m
[90mstdout[2m | test/dispatch.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env.test -- tip: ≡ƒöÉ prevent building .env in docker: https://dotenvx.com/prebuild

{"level":30,"time":1770638848110,"pid":19620,"hostname":"DESKTOP-3P240QT","msg":"Incident AI Queue initialized"}
{"level":50,"time":1770638848136,"pid":19620,"hostname":"DESKTOP-3P240QT","err":{"type":"AggregateError","message":"","stack":"AggregateError: \n    at internalConnectMultiple (node:net:1134:18)\n    at afterConnectMultiple (node:net:1715:7)","aggregateErrors":[{"type":"Error","message":"connect ECONNREFUSED ::1:6379","stack":"Error: connect ECONNREFUSED ::1:6379\n    at createConnectionError (node:net:1678:14)\n    at afterConnectMultiple (node:net:1708:16)","errno":-4078,"code":"ECONNREFUSED","syscall":"connect","address":"::1","port":6379},{"type":"Error","message":"connect ECONNREFUSED 127.0.0.1:6379","stack":"Error: connect ECONNREFUSED 127.0.0.1:6379\n    at createConnectionError (node:net:1678:14)\n    at afterConnectMultiple (node:net:1708:16)","errno":-4078,"code":"ECONNREFUSED","syscall":"connect","address":"127.0.0.1","port":6379}],"code":"ECONNREFUSED"},"msg":"Incident Queue error"}
 [31mΓ¥»[39m test/dispatch.test.ts [2m([22m[2m0 test[22m[2m)[22m

node.exe : [31mΓÄ»ΓÄ»ΓÄ»Γ
Ä»ΓÄ»ΓÄ»[1m[7m Failed 
Suites 9 [27m[22mΓÄ»ΓÄ»Γ
Ä»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[39m
At C:\Program 
Files\nodejs\npm.ps1:29 
char:3
+   & $NODE_EXE 
$NPM_CLI_JS $args
+   ~~~~~~~~~~~~~~~~~~~~~~
~~~~~~~
    + CategoryInfo        
      : NotSpecified: (  
  [31mΓÄ»ΓÄ»ΓÄ»Γ...»ΓÄ»   
 ΓÄ»ΓÄ»[39m:String) [    
], RemoteException
    + FullyQualifiedError 
   Id : NativeCommandErr  
  or
 

[31m[1m[7m FAIL 
[27m[22m[39m test/admin
Crud.test.ts[2m [ 
test/adminCrud.test.ts 
][22m
[31m[1m[7m FAIL 
[27m[22m[39m test/admin
Metrics.test.ts[2m [ 
test/adminMetrics.test.ts 
][22m
[31m[1m[7m FAIL 
[27m[22m[39m 
test/auth.test.ts[2m [ 
test/auth.test.ts ][22m
[31m[1m[7m FAIL 
[27m[22m[39m 
test/dispatch.test.ts[2m 
[ test/dispatch.test.ts 
][22m
[31m[1m[7m FAIL 
[27m[22m[39m 
test/gis.test.ts[2m [ 
test/gis.test.ts ][22m
[31m[1m[7m FAIL 
[27m[22m[39m 
test/incident.test.ts[2m 
[ test/incident.test.ts 
][22m
[31m[1m[7m FAIL 
[27m[22m[39m test/passw
ordReset.test.ts[2m [ tes
t/passwordReset.test.ts 
][22m
[31m[1m[7m FAIL 
[27m[22m[39m 
test/userRbac.test.ts[2m 
[ test/userRbac.test.ts 
][22m
[31m[1mPrismaClientIniti
alizationError[22m: 
`PrismaClient` needs to 
be constructed with a 
non-empty, valid 
`PrismaClientOptions`:

```
new PrismaClient({
  ...
})
```

or

```
constructor() {
  super({ ... });
}
```
          [39m
[90m [2mΓ¥»[22m new t n
ode_modules/@prisma/client
/src/runtime/getPrismaClie
nt.ts:[2m259:15[22m[39m
[36m [2mΓ¥»[22m src/mid
dleware/audit.ts:[2m4:16
[22m[39m
    [90m  2| 
[39m[35mimport[39m { 
[33mPrismaClient[39m } 
[35mfrom[39m [32m'@pris
ma/client'[39m[33m;[39m
    [90m  3| [39m
    [90m  4| 
[39m[35mconst[39m 
prisma [33m=[39m 
[35mnew[39m [33mPrismaC
lient[39m()[33m;[39m
    [90m   | [39m       
        [31m^[39m
    [90m  5| [39m
    [90m  6| 
[39m[35mexport[39m 
[35mconst[39m 
auditMiddleware 
[33m=[39m 
(req[33m:[39m [33mReque
st[39m[33m,[39m 
res[33m:[39m [33mRespon
se[39m[33m,[39m 
next[33m:[39m 
[33mNex[39mΓÇª
[90m [2mΓ¥»[22m src/app
.ts:[2m16:32[22m[39m

[31m[2mΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ
»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»Γ
Ä»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
[1/10]ΓÄ»[22m[39m

[31m[1m[7m FAIL 
[27m[22m[39m 
test/audit.test.ts[2m [ 
test/audit.test.ts ][22m
[31m[1mError[22m: 
[vitest] No "Role" export 
is defined on the 
"@prisma/client" mock. 
Did you forget to return 
it from "vi.mock"?
If you need to partially 
mock a module, you can 
use "importOriginal" 
helper inside:
[39m
vi[33m.[39m[34mmock[39
m([35mimport[39m([32m"@
prisma/client"[39m)[33m,
[39m [35masync[39m 
(importOriginal) 
[33m=>[39m {
  [35mconst[39m actual 
[33m=[39m 
[35mawait[39m 
[34mimportOriginal[39m()
  [35mreturn[39m {
    [33m...[39mactual[3
3m,[39m
    [90m// your mocked 
methods[39m
  }
})

[36m [2mΓ¥»[22m src/mod
ules/auth/auth.routes.ts:
[2m46:16[22m[39m
    [90m 44| [39m  [32m
'/revoke/:userId'[39m[33
m,[39m
    [90m 45| [39m  
requireAuth[33m,[39m
    [90m 46| [39m  [34m
requireRole[39m([[33mRol
e[39m[33m.[39m[33mADMI
N[39m])[33m,[39m
    [90m   | [39m       
        [31m^[39m
    [90m 47| [39m  
[35masync[39m 
(req[33m:[39m 
any[33m,[39m 
res[33m:[39m any) 
[33m=>[39m {
    [90m 48| [39m    
[35mtry[39m {
[90m [2mΓ¥»[22m src/app
.ts:[2m8:31[22m[39m

[31m[2mΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ
»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»Γ
Ä»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
[2/10]ΓÄ»[22m[39m

[31m[1m[7m FAIL 
[27m[22m[39m 
test/audit.test.ts[2m [ 
test/audit.test.ts ][22m
[31m[1mTypeError[22m: 
prisma.$disconnect is not 
a function[39m
[36m [2mΓ¥»[22m test/se
tup.ts:[2m49:18[22m[39m
    [90m 47| [39m[34maf
terAll[39m([35masync[39
m () [33m=>[39m {
    [90m 48| [39m  
[35mif[39m (prisma) {
    [90m 49| [39m    
[35mawait[39m prisma[33
m.[39m[34m$disconnect[3
9m()[33m;[39m
    [90m   | [39m       
          [31m^[39m
    [90m 50| [39m  }
    [90m 51| 
[39m})[33m;[39m

[31m[2mΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ
»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»Γ
Ä»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
[3/10]ΓÄ»[22m[39m

[2m Test Files [22m [1m[31m9 failed[39m[22m[90m (9)[39m
[2m      Tests [22m [33m4 skipped[39m[90m (4)[39m
[2m   Start at [22m 15:06:59
[2m   Duration [22m 29.68s[2m (transform 1.05s, setup 535ms, collect 53ms, tests 1.29s, environment 5ms, prepare 2.27s)[22m

