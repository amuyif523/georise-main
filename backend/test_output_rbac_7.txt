
> backend@1.0.0 test
> dotenv -e .env.test -- vitest run test/userRbac.test.ts


[1m[7m[36m RUN [39m[27m[22m [36mv2.1.9 [39m[90mC:/Users/Amanuel/Desktop/georise-main/backend[39m

[90mstdout[2m | test/userRbac.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env.test -- tip: ΓÜÖ∩╕Å  specify custom .env file path with { path: '/custom/path/.env' }

{"level":30,"time":1770651261714,"pid":11176,"hostname":"DESKTOP-3P240QT","msg":"Incident AI Queue initialized"}
node.exe : Sourcemap for "
C:/Users/Amanuel/Desktop/g
eorise-main/node_modules/n
ode-cron/dist/esm/node-cro
n.js" points to missing 
source files
At C:\Program 
Files\nodejs\npm.ps1:29 
char:3
+   & $NODE_EXE 
$NPM_CLI_JS $args
+   ~~~~~~~~~~~~~~~~~~~~~~
~~~~~~~
    + CategoryInfo        
      : NotSpecified: (S  
  ourcemap for "...ng s   
 ource files:String) [    
], RemoteException
    + FullyQualifiedError 
   Id : NativeCommandErr  
  or
 
{"level":50,"time":1770651262795,"pid":11176,"hostname":"DESKTOP-3P240QT","err":{"type":"Error","message":"Account is inactive","stack":"Error: Account is inactive\n    at AuthService.login (C:\\Users\\Amanuel\\Desktop\\georise-main\\backend\\src\\modules\\auth\\auth.service.ts:174:13)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)\n    at login (C:\\Users\\Amanuel\\Desktop\\georise-main\\backend\\src\\modules\\auth\\auth.controller.ts:18:20)"},"msg":"Login error"}
{"level":50,"time":1770651262950,"pid":11176,"hostname":"DESKTOP-3P240QT","err":{"type":"Error","message":"User not active","stack":"Error: User not active\n    at AuthService.rotateRefresh (C:\\Users\\Amanuel\\Desktop\\georise-main\\backend\\src\\modules\\auth\\auth.service.ts:255:71)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)\n    at C:\\Users\\Amanuel\\Desktop\\georise-main\\backend\\src\\modules\\auth\\refresh.routes.ts:12:20"},"msg":"Refresh token error"}
{"level":50,"time":1770651263178,"pid":11176,"hostname":"DESKTOP-3P240QT","correlationId":"ceeb5d87-d50f-4211-9e5a-6a5bae125795","traceId":"beb77988-a087-42b9-b577-c3b75bf470d3","err":{"type":"TypeError","message":"__vite_ssr_import_5__.default.agencyStaff.findUnique is not a function","stack":"TypeError: __vite_ssr_import_5__.default.agencyStaff.findUnique is not a function\n    at C:\\Users\\Amanuel\\Desktop\\georise-main\\backend\\src\\modules\\admin\\admin.routes.ts:804:44\n    at Layer.handleRequest (C:\\Users\\Amanuel\\Desktop\\georise-main\\backend\\node_modules\\router\\lib\\layer.js:152:17)\n    at next (C:\\Users\\Amanuel\\Desktop\\georise-main\\backend\\node_modules\\router\\lib\\route.js:157:13)\n    at C:\\Users\\Amanuel\\Desktop\\georise-main\\backend\\src\\middleware\\validate.ts:14:5\n    at Layer.handleRequest (C:\\Users\\Amanuel\\Desktop\\georise-main\\backend\\node_modules\\router\\lib\\layer.js:152:17)\n    at next (C:\\Users\\Amanuel\\Desktop\\georise-main\\backend\\node_modules\\router\\lib\\route.js:157:13)\n    at file:///C:/Users/Amanuel/Desktop/georise-main/backend/node_modules/express-rate-limit/dist/index.mjs:913:7\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)\n    at file:///C:/Users/Amanuel/Desktop/georise-main/backend/node_modules/express-rate-limit/dist/index.mjs:796:5"},"stack":"TypeError: __vite_ssr_import_5__.default.agencyStaff.findUnique is not a function\n    at C:\\Users\\Amanuel\\Desktop\\georise-main\\backend\\src\\modules\\admin\\admin.routes.ts:804:44\n    at Layer.handleRequest (C:\\Users\\Amanuel\\Desktop\\georise-main\\backend\\node_modules\\router\\lib\\layer.js:152:17)\n    at next (C:\\Users\\Amanuel\\Desktop\\georise-main\\backend\\node_modules\\router\\lib\\route.js:157:13)\n    at C:\\Users\\Amanuel\\Desktop\\georise-main\\backend\\src\\middleware\\validate.ts:14:5\n    at Layer.handleRequest (C:\\Users\\Amanuel\\Desktop\\georise-main\\backend\\node_modules\\router\\lib\\layer.js:152:17)\n    at next (C:\\Users\\Amanuel\\Desktop\\georise-main\\backend\\node_modules\\router\\lib\\route.js:157:13)\n    at file:///C:/Users/Amanuel/Desktop/georise-main/backend/node_modules/express-rate-limit/dist/index.mjs:913:7\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)\n    at file:///C:/Users/Amanuel/Desktop/georise-main/backend/node_modules/express-rate-limit/dist/index.mjs:796:5","msg":"Unhandled error"}
{"level":50,"time":1770651263180,"pid":11176,"hostname":"DESKTOP-3P240QT","correlationId":"ceeb5d87-d50f-4211-9e5a-6a5bae125795","traceId":"beb77988-a087-42b9-b577-c3b75bf470d3","path":"/api/admin/agency/users/1905","method":"PATCH","status":500,"durationMs":12.8218,"msg":"Request finished with server error"}
 [31mΓ¥»[39m test/userRbac.test.ts [2m([22m[2m2 tests[22m[2m | [22m[31m1 failed[39m[2m)[22m[33m 591[2mms[22m[39m
   [33m[2mΓ£ô[22m[39m User RBAC and deactivation[2m > [22mblocks login and refresh for deactivated users [33m333[2mms[22m[39m
[31m   [31m├ù[31m User RBAC and deactivation[2m > [22mprevents agency staff from mutating users in other agencies[90m 239[2mms[22m[31m[39m
[31m     ΓåÆ expected 500 to be 403 // Object.is equality[39m

[31mΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
[1m[7m Failed Tests 1 [
27m[22mΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
ΓÄ»[39m

[31m[1m[7m FAIL 
[27m[22m[39m 
test/userRbac.test.ts[2m 
> [22mUser RBAC and 
deactivation[2m > 
[22mprevents agency 
staff from mutating users 
in other agencies
[31m[1mAssertionError[2
2m: expected 500 to be 
403 // Object.is 
equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 403[39m
[31m+ 500[39m

[36m [2mΓ¥»[22m test/us
erRbac.test.ts:[2m140:24
[22m[39m
    [90m138| [39m      
[33m.[39m[34msend[39m({
 staffRole[33m:[39m 
[32m'SUPERVISOR'[39m 
})[33m;[39m
    [90m139| [39m
    [90m140| [39m    [3
4mexpect[39m(res[33m.[3
9mstatus)[33m.[39m[34mt
oBe[39m([34m403[39m)[3
3m;[39m
    [90m   | [39m       
                
[31m^[39m
    [90m141| [39m  
})[33m;[39m
    [90m142| 
[39m})[33m;[39m

[31m[2mΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ
»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»Γ
Ä»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
ΓÄ»[1/1]ΓÄ»[22m[39m

[2m Test Files [22m [1m[31m1 failed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[31m1 failed[39m[22m[2m | [22m[1m[32m1 passed[39m[22m[90m (2)[39m
[2m   Start at [22m 18:34:19
[2m   Duration [22m 3.58s[2m (transform 757ms, setup 74ms, collect 2.34s, tests 591ms, environment 0ms, prepare 277ms)[22m

